(function(root){var options={citationClass:'citation',numberGlosses:true,prettyMergedColumns:true,rowClasses:{1:'source',2:'morphemes',3:'translation',4:'translation'},selector:".gloss",showFormattingErrors:true,syntheticLanguage:false,useSmallCaps:true,useFakeSmallCaps:false};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(needle){for(var i=0;i<this.length;i++)if(this[i]===needle)return i;return-1};function gloss(){return{options:options,raw:{},layout:function(line){var preformatArray=line.match(/(!\s)?(`|"|'((?!\s)|^)).+?("|(?=').*?`|"|'((?=\s)|$))|[^\s]+/g);if(options.useSmallCaps)if(options.useFakeSmallCaps){preformatArray=preformatArray.map(setFakeSmallCaps)}else preformatArray=preformatArray.map(setSmallCaps);preformatArray=preformatArray.map(setSubAndSuperscript);preformatArray=preformatArray.map(setZeroMorpheme);return preformatArray},configure:function(opts){for(var prop in opts)if(opts.hasOwnProperty(prop))if(prop==='rowClasses'){for(var row in opts[prop])this.options[prop][row]=opts[prop][row]}else this.options[prop]=opts[prop];this.setGloss()},setGloss:function(){var selector=this.options.selector,glosses=document.querySelectorAll(selector);if(this.raw[selector]){for(var g=0;g<this.raw[selector].length;g++)glosses[g].innerHTML=this.raw[selector][g]}else{var rawArr=[];for(var pos=glosses.length;pos--;rawArr.unshift(glosses[pos].innerHTML));if(!this.raw[selector])this.raw[selector]=rawArr};for(var i=0;i<glosses.length;i++){var lines=glosses[i].innerHTML.trim().split(/<br\/?>/),hasTitle=glosses[i].dataset.title!=="0",isSynthetic=(glosses[i].dataset.synthetic==="1"||options.syntheticLanguage),output="",fullLength=[],fullLengthOutput="",skipRow=[],wordIdxlines,wordzips;if(hasTitle){title="<div class=\"gloss-row gloss-full "+options.citationClass+"\">"+setSubAndSuperscript(lines[0])+"</div>";lines=lines.slice(1)}else title="";wordIdxlines=equalizeArrayLength(lines.map(this.layout));wordzips=zipn(wordIdxlines);if(options.numberGlosses)output="<div class=\"gloss-segment gloss-label\"><a href=\"#gloss"+(i+1)+"\">("+(i+1)+")</a></div>";output+="<title>";skipRow=[];for(var col=0;col<wordzips.length;col++){var formattedGloss="",currentColumn=wordzips[col],firstChar="";if(wordzips[col].indexOf("xx")>-1&&options.prettyMergedColumns){formattedGloss="<div class=\"gloss-segment gloss-merged\">"}else formattedGloss="<div class=\"gloss-segment\">";for(var wordIdx=0;wordIdx<currentColumn.length;wordIdx++){if(skipRow&&skipRow.indexOf(wordIdx)>-1)continue;firstChar=currentColumn[wordIdx].charAt(0);if(!currentColumn[wordIdx]&&options.showFormattingErrors){formattedGloss+="<span class=\"gloss-error\">Error</span><br/>"}else if(currentColumn[wordIdx]==="xx"){formattedGloss+="&nbsp;"}else if(firstChar==='!'||(isSynthetic&&wordIdx===1)){if(firstChar==='!'){str=currentColumn[wordIdx].substring(1).trim();if(str.startsWith("`")&&str.endsWith("`"))str=str.slice(1,-1);fullLength.push(str)}else if(isSynthetic&&wordIdx===1){temp="";for(var t=0;t<wordzips.length;t++)temp+=printWord(1,wordzips[t][1],options);fullLength.push(temp)}else fullLength.push(currentColumn[wordIdx]);skipRow.push(wordIdx)}else{formattedGloss+=printWord(wordIdx,currentColumn[wordIdx],options);if(wordIdx!==currentColumn.length-1)formattedGloss+="<br/>"}};formattedGloss+="</div>";output+=formattedGloss};if(fullLength){var numBreaks=lines.length-fullLength.length+1,row=0,hasTitle=(glosses[i].dataset.title!=="0"),titleText="";fullLengthOutput=(new Array(numBreaks)).join("<br/>");for(row;row<fullLength.length;row++)fullLengthOutput+="<div class=\"gloss-row gloss-full "+options.rowClasses[lines.length]+"\">"+fullLength[row]+"</div>"};output=output.replace('<title>',title);glosses[i].innerHTML=output+fullLengthOutput;if(glosses[i].className.indexOf("formatted-gloss")===-1)glosses[i].className+=" formatted-gloss";var cf=document.createElement("div");cf.className="clearfix";glosses[i].appendChild(cf)}}}}
function zipn(xss){var zipped=[];for(var k=0;k<xss[0].length;k++)zipped[k]=[];for(var i=0;i<xss[0].length;i++)for(var j=0;j<xss.length;j++)zipped[i]=zipped[i].concat(xss[j][i]);return zipped}
function fixSpaces(string){return string.replace(/\//g,"")}
function setSmallCaps(string){return string.replace(/\*(\S+?)\*/g,'<span class="morpheme">$1</span>')}
function setSubAndSuperscript(string){var s=string.replace(/_{([^}]*)}/g,'<sub>$1</sub>');s=s.replace(/_(\S+?)/g,'<sub>$1</sub>');s=s.replace(/\^{([^}]*)}/g,'<sup>$1</sup>');s=s.replace(/\^(\S+?)/g,'<sup>$1</sup>');return s}
function setFakeSmallCaps(string){return string.replace(/\*(\S+?)\*/g,'<span class="morpheme-fake-caps">$1</span>')}
function setZeroMorpheme(string){return string.replace(/\\0/g,'&#x2205')}
function equalizeArrayLength(arrays){var max=0;for(var i=arrays.length-1;i>=0;i--)if(arrays[i].length>max)max=arrays[i].length;for(var j=arrays.length-1;j>=0;j--)if(arrays[j].length<max)while(arrays[j].length<max)arrays[j].push('');return arrays}
function printWord(idx,word,options){return"<span class=\"gloss-row"+idx+" "+options.rowClasses[idx+1]+"\">"+word+"</span>"};root.gloss=gloss();root.gloss.setGloss()})(this)